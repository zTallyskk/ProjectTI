#{extends 'main.html' /}
#{set title:'Lista de Pessoas Pendentes' /}

<h2>Busca de Pessoas</h2>

<form id="formBusca" onsubmit="return false;">
    <input 
        type="text" 
        id="termoBusca" 
        name="termo" 
        placeholder="Buscar por nome ou email..." 
        value="${termo ?: ''}" 
    />
    <button type="submit">Buscar</button>
</form>

<div id="lista-pessoas-container">
    #{include 'Pessoas/tabelaPessoas.html' /}
</div>

<script type="text/javascript" charset="${_response_encoding}">
    $(document).ready(function() { 
        // Função central que faz a chamada AJAX e atualiza o container
        function carregarLista(termo) {
            // Feedback visual enquanto carrega
            $('#lista-pessoas-container').html('<p>Carregando resultados...</p>');
            
            // Requisição AJAX
            $.ajax({
                url: '@{Pessoas.listar()}', 
                type: 'GET',
                data: { 
                    termo: termo // Parâmetro que será mapeado para 'String termo' no seu Controller
                },
                success: function(html) {
                    // Substitui o conteúdo do container com o HTML retornado (a tabela)
                    $('#lista-pessoas-container').html(html);
                },
                error: function(xhr, status, error) {
                    // Trata possíveis erros de comunicação
                    $('#lista-pessoas-container').html('<p style="color: red;">Erro ao carregar a lista: ' + error + '</p>');
                }
            });
        }

        // A. Dispara a busca quando o usuário clica no botão "Buscar"
        $('#formBusca').submit(function(e) {
            // e.preventDefault(); // O onsubmit="return false;" já faz isso
            const termo = $('#termoBusca').val();
            carregarLista(termo);
        });
        
        $('#termoBusca').on('keyup', function () {
            clearTimeout(typingTimer);
            // Só executa a busca se o usuário parar de digitar por 500ms
            typingTimer = setTimeout(function() {
                const termo = $('#termoBusca').val();
                carregarLista(termo);
            }, doneTypingInterval);
        });

    });
</script>